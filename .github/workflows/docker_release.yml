name: Build and Push Docker veg-workflows-aws and mep-veg-workflows images

on:
  workflow_run:
    workflows: ["Publish Wheel"]
    types:
      - completed
  workflow_dispatch: # Allow manual triggering of the workflow (optional)
    inputs:
      job-to-run:
        description: "Which job to run"
        required: true
        default: "all" # or 'mep-build-docker'

env:
  token: ${{ secrets.GITHUB_TOKEN }} # Use the built-in GITHUB_TOKEN for authentication
  UV_INDEX_VITO_ARTIFACTORY_USERNAME: ${{ secrets.ARTIFACTORY_USERNAME }}
  UV_INDEX_VITO_ARTIFACTORY_PASSWORD: ${{ secrets.ARTIFACTORY_PASSWORD }}
  DOCKER_REGISTRY: vito-docker-private.artifactory.vgt.vito.be
  DOCKER_IMAGE_NAME: veg-tools-aws
  MEP_BASE_IMAGE_NAME: veg-tools

jobs:
  extract-version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get_version.outputs.version }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Extract version from _version.py
        id: get_version
        run: |
          # Find _version.py file recursively under ./src
          VERSION_FILE=$(find ./src -name "_version.py" -type f | head -n 1)

          if [ -z "$VERSION_FILE" ]; then
            echo "Error: _version.py file not found under ./src directory"
            exit 1
          fi

          echo "Found version file: $VERSION_FILE"

          # Extract version without quotes
          VERSION=$(grep -oP '__version__\s*=\s*"\K[^"]+' "$VERSION_FILE" | tr '+' '-')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version from _version.py: $VERSION"

  build-docker:
    needs: extract-version # ADD THIS LINE
    if: |
      github.event_name == 'workflow_run' ||
      github.event.inputs.job-to-run == 'all' ||
      github.event.inputs.job-to-run == 'aws-build-docker'
    runs-on: ubuntu-latest
    steps:
      # Step 1: Check out the repository
      - name: Checkout repository
        uses: actions/checkout@v6

      # Step 2: Log in to Docker Hub or another container registry
      - name: Log in to Vito Docker Registry
        uses: docker/login-action@v3
        with:
          registry: vito-docker-private.artifactory.vgt.vito.be
          username: ${{ secrets.ARTIFACTORY_USERNAME }}
          password: ${{ secrets.ARTIFACTORY_PASSWORD }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Step 3: Build and push the Docker image
      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: ../
          file: ./docker-cloud/dockerfile
          push: true
          tags: ${{ env.DOCKER_REGISTRY }}/lcfm/${{ env.DOCKER_IMAGE_NAME }}:${{ needs.extract-version.outputs.version }}
          secrets: |
            uv_username=${{ secrets.ARTIFACTORY_USERNAME }}
            uv_password=${{ secrets.ARTIFACTORY_PASSWORD }}
          build-args: |
            VEG_RELEASE_VERSION=${{ needs.extract-version.outputs.version }}
          cache-from: type=registry,ref=${{ env.DOCKER_REGISTRY }}/lcfm/${{ env.DOCKER_IMAGE_NAME }}:buildcache
          cache-to: type=registry,ref=${{ env.DOCKER_REGISTRY }}/lcfm/${{ env.DOCKER_IMAGE_NAME }}:buildcache,mode=max

  mep-build-docker:
    needs: extract-version # ADD THIS LINE
    if: |
      github.event_name == 'workflow_run' ||
      github.event.inputs.job-to-run == 'all' ||
      github.event.inputs.job-to-run == 'mep-build-docker'
    runs-on: ubuntu-latest
    steps:
      # Step 1: Check out the repository
      - name: Checkout repository
        uses: actions/checkout@v6

      # Step 2: Log in to Docker Hub or another container registry
      - name: Log in to Vito Docker Registry
        uses: docker/login-action@v3
        with:
          registry: vito-docker-private.artifactory.vgt.vito.be
          username: ${{ secrets.ARTIFACTORY_USERNAME }}
          password: ${{ secrets.ARTIFACTORY_PASSWORD }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Step 3: Build and push the Docker image
      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: mep.dockerfile
          push: true
          tags: ${{ env.DOCKER_REGISTRY }}/${{ env.MEP_BASE_IMAGE_NAME }}:${{ needs.extract-version.outputs.version }}
          secrets: |
            uv_username=${{ secrets.ARTIFACTORY_USERNAME }}
            uv_password=${{ secrets.ARTIFACTORY_PASSWORD }}
          build-args: |
            VEG_RELEASE_VERSION=${{ needs.extract-version.outputs.version }}
          cache-from: type=registry,ref=${{ env.DOCKER_REGISTRY }}/${{ env.MEP_BASE_IMAGE_NAME }}:buildcache
          cache-to: type=registry,ref=${{ env.DOCKER_REGISTRY }}/${{ env.MEP_BASE_IMAGE_NAME }}:buildcache,mode=max
